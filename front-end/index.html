<!DOCTYPE html>

<html>
<head>
	<title>MQTT Project</title>
    <meta name="format-detection">
    <meta name="msapplication-tap-highlight">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  	<script>
  	function myFunction(){

		var noble = require('noble'); //load the BLE noble module c.f. https://github.com/noble/noble

var peripheralOfInterestUUID = 'c3c29996610a'; //change the value of xyz to match uuid of peripheral of interest e.g. d6619d652945
var serviceOfInterest = 2; //0 by default, needs to be set to array index that matches the service of interest
var characteristicOfInterest = 0; //0 by default, needs to be set to array index that matches the characteristic of interest

//global variable - shared between functions
var peripheralGlobal;
var actuatorData;

noble.on('stateChange', stateChangeEventHandler); //when a stateChange event occurs call the event handler callback function, discoverDeviceEventHandler

function stateChangeEventHandler(state) { //event handler callback function
  if (state === 'poweredOn') {
    console.log("starting scanning");
    noble.startScanning();
  } else {
    console.log("stopping scanning");
    noble.stopScanning();
  }
}

noble.on('discover', discoverDeviceEventHandler); //when a discover event occurs call the event handler callback function, discoverDeviceEventHandler
console.log("up and running");

function discoverDeviceEventHandler(peripheral) { //event handler callback function
	console.log('Found device with local name: ' + peripheral.advertisement.localName);
	//console.log('advertising the following service uuid\'s: ' + peripheral.advertisement.serviceUuids);
	console.log("peripheral uuid : " + peripheral.uuid);
	//if (peripheral.advertisement.localName == "BBC micro:bit [gugiv]"){
    if (peripheral.uuid == peripheralOfInterestUUID){
        peripheralGlobal = peripheral;  //set the peripheralGlobal variable equal to the callback peripheral parameter value
		console.log(peripheral.uuid);
		peripheral.connect(connectCallback); //call the connect function and when it returns the callback function connectCallback will be executed
	}; //end if
}

function connectCallback(error) { //this will be executed when the connect request returns
	if (error) {
		console.log("error connecting to peripheral");
	} else {
		console.log('connected to peripheral: ' + peripheralGlobal.uuid  + "   " + peripheralGlobal.advertisement.localName);
		peripheralGlobal.discoverServices([], discoverServicesCallback); //call the discoverServices function and when it returns the callback function discoverServicesCallback will be executed
	}
}

function discoverServicesCallback(error, services) { //this will be executed when the discoverServices request returns
	if (error) {
		console.log("error discovering services");
	} else {
		console.log("The device contains the following services");
		for (var i in services) {
			console.log('  ' + i + ' uuid: ' + services[i].uuid);
		}
        //pick one service to interrogate
		var deviceInformationService = services[serviceOfInterest];
		deviceInformationService.discoverCharacteristics(null, discoverCharsCallback); //call the discoverCharacteristics function and when it returns the callback function discoverCharsCallback will be executed
	}
}

function discoverCharsCallback(error, characteristics) { //this will be executed when the discoverCharacteristics request returns
	if (error) {
		console.log("error discovering characteristics");
	} else {
		console.log('discovered the following characteristics associated with the service:');
		for (var i in characteristics) {
			console.log('  ' + i + ' uuid: ' + characteristics[i].uuid);
        }
        //pick one characteristic to write to
        actuatorData = characteristics[characteristicOfInterest];

        characteristics[i].read(readDataCallback);

        //actuatorData.write(new Buffer([1]), false, writeDataCallback); //call the write function and when it returns the callback function writeDataCallback will be executed
		} //end for loop
}

function readDataCallback(error, data) { //this will be executed when the read request returns
	if (error) {
		console.log("error reading data");
	} else {
        console.log("Current actuator state is : " + data.toString('hex'));
        if (data.toString('hex') == '00') { //if LED is off, turn it on or blining
            actuatorData.write(new Buffer([1]), false, writeDataCallback);
	        console.log("Turned actuator on");
            //call the write function and when it returns the callback function writeDataCallback will be executed
        } else { //if LED is on, turn it off
            actuatorData.write(new Buffer([0]), false, writeDataCallback);
			console.log("Turned actuator off");
        }
		//peripheralGlobal.disconnect(disconnectCallback);
	}
}
function writeDataCallback(error, data) { //this will be executed when the write request returns
	if (error) {
		console.log("error writing data");
	} else {
		//peripheralGlobal.disconnect(disconnectCallback);
	}
}

function disconnectCallback(error){ //this will be executed when the disconnect request returns
	if (error) {
		console.log("error disconnecting");
	} else {
		console.log("Disconnecting and stopping scanning");
	}
}

  	}

  	</script>

	<style>
	body{
	 	background-repeat: no-repeat;  /* Do not repeat the image */
		background-attachment: fixed; /* Prevent img from moving */
		background-position: center; /* Center the image */
  		background-size: cover;  /* Resize the background image to cover the entire container */
	}
	pre {
		width: 600px;
	}
	textarea#messageToPublishTo {
		  resize: none;
		  width: 600px;
		  overflow: auto;
	}
	.jumbotron {
	  height:350px;
	  width: 650px;
	  position : center;
	  top:10px;
	}
	</style>

</head>
<body background = "iot_bkgnd.jpg">

<!--navigation bar fixed bottom makes the bar follow the screen if it was longer-->
<nav class="navbar navbar-inverse navbar-fixed-bottom">
	<div class="container-fluid">

				<!--navigation bar -->
				<div class = "navbar-header">
					<!--logo-->
					<a = href="https://github.com/Maksthorn/Raspberry-pie-cloud-server" class="navbar-brand">Maks IoT Project</a>
				</div>

				<!-- items on navigation bar-->
				<div>
					<!-- unordered list of buttons in list tags-->
					<ul class="nav navbar-nav">
						<!--groups buttons together -->
						<div class = "btn-group">
							<!--navigation bar -->
        					<button id = "connect" class="btn btn-success">Connect</button>
        					<button id = "publish" class="btn btn-primary">Publish</button>
        				</div>
        			</ul>

        			<ul class="nav navbar-nav navbar-right">
					<li><button id = "disconnect" class= "btn btn-danger">Disconnect</button></li>
        			</ul>

        		</div>

    </div><!-- close fluid-container -->
</nav><!-- close navbar -->

		<div class= "row">
				</br>
				<div class="col-sm-4"></div>
    	    	<label for="topicToPublishTo">Topic:</label></br>

    	    	<div class="col-sm-4"></div>
    	    	<input type ="text" id = "topicToPublishTo" placeholder = "Topic name"></br>

    	    	<div class="col-sm-4"></div>
    	    	<label for="messageToPublishTo">Message:</label>

    	    	</br>
				<div class="col-sm-4"></div>
    	    	<textarea rows = "3" type ="text" id = "messageToPublishTo" placeholder = "Message you wish to send"></textarea>


    	    <!--preformated text tag puts a container around message text area-->

    	    <div>
				<div class="col-sm-4"></div>
				<pre>
    	    	<p id = "message_sent">Last message sent</p>
				</pre>
			</div>

			<div class="col-sm-4"></div>
			<div>
				<button onclick = "myFunction()">test</button>
			</div>
		</div> <!-- end of row div -->

		<!-- include link to js files required -->
		<script type="text/javascript" src="paho-mqtt.js" ></script>
        <!--This is a reference to the Paho Javascript client side browser based library-->
        <script type="text/javascript" src="MQTTbrowserConn_PubForHive.js"></script>
</body>
</html>


